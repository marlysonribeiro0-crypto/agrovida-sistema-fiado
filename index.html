<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrovida PRO - Sistema Oficial</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --primary: #009e2a; --primary-dark: #007a21; --secondary: #2c3e50; --accent: #ffb900; --bg: #f4f7f6; --text: #2c3e50; --white: #ffffff; --danger: #e74c3c; --border: #e0e0e0; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Inter, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--secondary); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-box img { max-width: 150px; margin-bottom: 20px; }
        .pin-input { font-size: 2rem; letter-spacing: 5px; text-align: center; width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; }
        .btn-login { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }

        /* LOADING */
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--secondary); color: var(--white); display: flex; flex-direction: column; padding: 20px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: 0.3s; z-index: 1000; height: 100%; }
        .brand { text-align: center; margin-bottom: 30px; padding: 20px 15px; background: white; }
        .brand img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
        
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 2000; background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 5px; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }

        .menu-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #bdc3c7; transition: 0.2s; text-decoration: none; font-size: 1rem; border-left: 4px solid transparent; position: relative; }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: var(--white); }
        .menu-item.active { background: rgba(255,255,255,0.1); color: var(--white); border-left-color: var(--accent); }
        .menu-item.active i { color: var(--accent); } 
        .notify-badge { background-color: var(--danger); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; position: absolute; right: 20px; font-weight: bold; display: none; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* MAIN CONTENT */
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; width: 100%; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; margin-top: 10px; }
        .page-title { font-size: 1.6rem; font-weight: 700; color: var(--secondary); display: flex; align-items: center; gap: 10px; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -280px; top: 0; height: 100%; }
            .sidebar.active { left: 0; }
            .mobile-menu-btn { display: block; }
            .sidebar-overlay.active { display: block; }
            .main-content { padding: 15px; padding-top: 60px; }
            .dashboard-grid, .grid-detalhe, .form-grid { grid-template-columns: 1fr !important; gap: 15px !important; }
            .full-width { grid-column: span 1 !important; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .page-header .btn-primary, .page-header .btn-back { width: 100%; justify-content: center; }
        }

        /* COMPONENTES */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .grid-detalhe { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 15px; }
        .card-icon { width: 50px; height: 50px; border-radius: 10px; background: #e8f8f5; color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; }
        .card-value { font-size: 2rem; font-weight: bold; color: var(--secondary); margin-top: 5px; }

        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-back { background: transparent; border: 1px solid #ccc; color: #666; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
        
        .table-container { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #f8f9fa; padding: 15px 20px; text-align: left; font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; }
        td { padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .action-btn { background: var(--secondary); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
        
        /* SEARCH BAR */
        .search-container { display: flex; align-items: center; background: #fff; border: 1px solid #ddd; border-radius: 50px; padding: 5px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; margin-bottom: 20px; }
        .search-container:focus-within { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1); }
        .search-container i { color: #aaa; font-size: 1.2rem; }
        .search-input { border: none; outline: none; width: 100%; padding: 10px; font-size: 1rem; margin-left: 10px; background: transparent; }

        /* FORM */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .full-width { grid-column: span 2; }

        /* OUTROS */
        .btn-gold { background: var(--accent); color: #fff; border: none; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; }
        .btn-archive { background: #e67e22; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; }
        .btn-history { background: #3498db; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-edit-client { background: #f39c12; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; }
        .btn-delete-client { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; }
        
        /* ALERTS */
        .alert-card { border-left: 5px solid var(--danger); background: #fff5f5; padding: 15px; margin-bottom: 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; white-space: nowrap; }
        .status-debt { background: #fadbd8; color: #c0392b; }
        .status-ok { background: #d5f5e3; color: #27ae60; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; padding: 10px; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; }
        .history-item { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: #fafafa; }
        .history-detail { display: none; margin-top: 10px; background: #fff; padding: 10px; border: 1px solid #eee; }
        .history-detail.show { display: block; }
        #modal-history-overlay { z-index: 2000; }
        #modal-print-overlay { z-index: 3000; } 

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; pointer-events: none; }
        .toast { background: var(--secondary); color: white; padding: 15px 25px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--primary); pointer-events: auto; }

        /* LABEL NUMERO DA NOTA */
        .note-number-badge {
            background-color: var(--secondary);
            color: var(--accent);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-block;
            margin-right: 10px;
        }

        /* IMPRESS√ÉO */
        #area-impressao { display: none; }
        @media print {
            body > *:not(#area-impressao) { display: none !important; }
            #area-impressao { display: block !important; position: absolute; left: 0; top: 0; background: white; width: 100%; }
            .estilo-bobina { width: 72mm; margin: 0 auto; font-family: monospace; font-size: 11px; }
            .estilo-a4 { width: 100%; font-family: sans-serif; padding: 20px; }
            .corte-linha { border-bottom: 1px dashed #000; margin: 20px 0; display:block }
            .via-impressao { margin-bottom: 40px; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="login-screen">
        <div class="login-box">
            <img src="logo.png" alt="Agrovida" style="max-height:80px">
            <h3 style="color: var(--secondary); margin-bottom: 20px;">Sistema Bloqueado</h3>
            <input type="password" id="login-pin" class="pin-input" placeholder="****" maxlength="4" inputmode="numeric">
            <button class="btn-login" onclick="checkLogin()">ENTRAR</button>
            <p id="login-error" style="color: red; margin-top: 10px; display: none;">Senha Incorreta!</p>
        </div>
    </div>

    <div id="loading-screen" style="display:none"><div class="spinner"></div><p style="margin-top:15px; color:#555">Sincronizando...</p></div>
    <div id="toast-container"></div>

    <div id="modal-print-overlay" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <h3>üñ®Ô∏è Imprimir</h3>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top:20px;">
                <button class="btn-primary" style="flex:1; background:white; color:#333; border:1px solid #ddd; flex-direction:column" onclick="executarImpressao('bobina')"><i class="fas fa-receipt fa-2x"></i><br>Bobina</button>
                <button class="btn-primary" style="flex:1; background:white; color:#333; border:1px solid #ddd; flex-direction:column" onclick="executarImpressao('a4')"><i class="fas fa-file-alt fa-2x"></i><br>A4</button>
            </div>
            <button onclick="document.getElementById('modal-print-overlay').style.display='none'" style="margin-top:20px; border:none; background:none; cursor:pointer; color:#999">Cancelar</button>
        </div>
    </div>

    <div id="modal-history-overlay" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3>üìú Hist√≥rico</h3><button onclick="document.getElementById('modal-history-overlay').style.display='none'" style="border:none; background:none; font-size:1.5rem">&times;</button></div>
            <div id="history-list"></div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="brand"><img src="logo.png" alt="Agrovida Mais"></div>
        <nav>
            <a id="menu-dashboard" class="menu-item active" onclick="navTo('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a id="menu-notifications" class="menu-item" onclick="navTo('notifications')"><i class="fas fa-bell"></i> Notifica√ß√µes <span id="badge-notify" class="notify-badge">0</span></a>
            <a id="menu-clientes" class="menu-item" onclick="navTo('clientes')"><i class="fas fa-users"></i> Clientes</a>
            <a id="menu-cadastro" class="menu-item" onclick="novoCadastro()"><i class="fas fa-user-plus"></i> Novo Cadastro</a>
        </nav>
        <div style="margin-top: auto; padding: 20px; text-align: center; font-size: 0.75rem; color: #7f8c8d;">Agrovida v31.0 (Oficial)</div>
    </aside>

    <main class="main-content">
        <section id="view-dashboard" class="view-section active">
            <div class="page-header"><div class="page-title">Vis√£o Geral</div></div>
            <div class="dashboard-grid">
                <div class="card"><div class="card-icon"><i class="fas fa-file-invoice-dollar"></i></div><div class="card-label">A RECEBER</div><div class="card-value" id="dash-total" style="color:var(--danger)">R$ 0,00</div></div>
                <div class="card"><div class="card-icon"><i class="fas fa-users"></i></div><div class="card-label">CLIENTES</div><div class="card-value" id="dash-clientes">0</div></div>
            </div>
        </section>

        <section id="view-notifications" class="view-section">
            <div class="page-header"><div class="page-title">üîî Alertas de Vencimento</div></div>
            <div class="card"><div id="notification-list"></div></div>
        </section>

        <section id="view-clientes" class="view-section">
            <div class="page-header">
                <div class="page-title">Gerenciar Clientes</div>
                <button class="btn-primary" onclick="novoCadastro()"><i class="fas fa-plus"></i> Novo</button>
            </div>
            <div class="table-container" style="padding: 20px; background: #f9f9f9;">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" id="search-client" placeholder="Buscar cliente..." onkeyup="renderClients()">
                </div>
                <table style="width: 100%; background: white;">
                    <thead><tr><th>Nota</th><th>Nome</th><th>Saldo</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="clientes-list"></tbody>
                </table>
            </div>
        </section>

        <section id="view-cadastro" class="view-section">
            <div class="page-header"><div class="page-title"><button class="btn-back" onclick="navTo('clientes')"><i class="fas fa-arrow-left"></i></button> &nbsp; <span id="form-title">Cadastro</span></div></div>
            <div class="card">
                <input type="hidden" id="edit-id">
                <div class="form-grid">
                    <div class="full-width form-group"><label>Nome</label><input type="text" id="cad-nome" class="input-next"></div>
                    <div class="form-group"><label>CPF</label><input type="text" id="cad-cpf" oninput="mascaraCPF(this)" class="input-next"></div>
                    <div class="form-group"><label>Tel</label><input type="tel" id="cad-tel" oninput="mascaraTel(this)" class="input-next"></div>
                    <div class="form-group"><label>Cidade</label><input type="text" id="cad-cidade" class="input-next"></div>
                    <div class="full-width form-group"><label>Endere√ßo</label><input type="text" id="cad-end" class="input-next"></div>
                </div>
                <button class="btn-primary" style="width: 100%; justify-content: center; margin-top: 20px;" onclick="saveClient()">Salvar</button>
            </div>
        </section>

        <section id="view-detalhe" class="view-section">
            <div class="page-header">
                <div class="page-title"><button class="btn-back" onclick="navTo('clientes')"><i class="fas fa-arrow-left"></i></button> &nbsp; 
                    <span id="detalhe-nome">Nome</span>
                </div>
                <div style="text-align: right">
                    <div id="note-number-display" class="note-number-badge" style="display:none">NOTA N¬∫ --</div>
                    <small>SALDO</small>
                    <div id="detalhe-saldo" style="font-size: 1.5rem; font-weight: 800; color:var(--danger)">R$ 0,00</div>
                </div>
            </div>
            
            <div class="grid-detalhe">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;"><h3>Extrato</h3><button class="btn-back" onclick="abrirModalPrint('extrato')"><i class="fas fa-print"></i></button></div>
                    <div style="max-height: 400px; overflow-y: auto;"><table><tbody id="detalhe-itens"></tbody></table></div>
                </div>

                <div>
                    <button id="btn-quitacao" class="btn-gold" style="display:none" onclick="abrirModalPrint('recibo')"><i class="fas fa-award"></i> Recibo</button>
                    <button id="btn-archive" class="btn-archive" style="display:none" onclick="arquivarCiclo()"><i class="fas fa-box-archive"></i> Arquivar</button>

                    <div class="card" style="margin-top: 15px; border: 2px solid var(--primary); padding:15px;">
                        <h4 style="color:var(--primary); margin-top:0"><i class="fas fa-cart-plus"></i> Venda</h4>
                        <input type="text" id="add-desc" class="input-next" placeholder="Produto" style="margin-bottom:10px; width:100%">
                        <div style="display:flex; gap:10px"><input type="number" id="add-qtd" class="input-next" value="1" placeholder="Qtd" style="flex:1"><input type="number" id="add-val" class="input-next" placeholder="R$ Un" style="flex:1.5"></div>
                        <input type="number" id="add-desc-val" class="input-next" placeholder="Desc (R$)" style="margin-top:10px; border-color:#ffeaa7; width:100%">
                        <button class="btn-primary" style="width:100%; justify-content:center; margin-top:15px" onclick="addItem()">Lan√ßar</button>
                    </div>

                    <div class="card" style="margin-top: 15px; background: #f0fdf4; padding:15px;">
                        <h4 style="color:green; margin-top:0">Receber</h4>
                        <input type="number" id="pay-val" class="input-next" placeholder="R$" style="width:100%; padding:10px; margin-bottom:10px;">
                        <button class="btn-primary" style="width:100%; background:green; justify-content:center;" onclick="addPayment()">Confirmar</button>
                    </div>

                    <div class="card" style="margin-top: 15px; padding:15px;">
                        <h4 style="color:#999; margin-top:0">Op√ß√µes</h4>
                        <p id="info-cpf" style="font-weight:bold; margin:5px 0"></p><p id="info-tel" style="margin:5px 0"></p>
                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button class="btn-edit-client" onclick="prepareEdit()"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn-delete-client" onclick="deleteClient()"><i class="fas fa-trash"></i> Excluir</button>
                        </div>
                        <button class="btn-history" onclick="abrirHistorico()"><i class="fas fa-history"></i> Hist√≥rico</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="area-impressao"></div>

    <script>
        // === HELPERS NO TOPO ===
        const mascaraCPF = i => i.value = i.value.replace(/\D/g,"").slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2");
        const mascaraTel = i => i.value = i.value.replace(/\D/g,"").slice(0,11).replace(/^(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d{4})$/,"$1-$2");
        const formatCurrency = val => {
            if (val === undefined || val === null || isNaN(val)) return "R$ 0,00";
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };
        function showToast(msg) { const c=document.getElementById('toast-container'); const t=document.createElement('div'); t.className='toast'; t.innerHTML=`<i class="fas fa-check-circle"></i> ${msg}`; c.appendChild(t); setTimeout(()=>t.remove(),3000); }

        // --- CHAVES ---
        const firebaseConfig = {
          apiKey: "AIzaSyAPQST9oBIqYOYNksPNaARpyW8K-nXiRtE",
          authDomain: "agrovida-system.firebaseapp.com",
          projectId: "agrovida-system",
          storageBucket: "agrovida-system.firebasestorage.app",
          messagingSenderId: "808503446468",
          appId: "1:808503446468:web:989d4e3fd8716c0fe3f291"
        };

        let db, localClients = [], currentClient = null, tipoImpressaoAtual = 'extrato', dadosImpressaoTemp = null;

        document.getElementById('login-pin').addEventListener('keydown', function(e) { if(e.key==='Enter') checkLogin(); });

        function checkLogin() {
            if(document.getElementById('login-pin').value === '1234') {
                document.getElementById('login-screen').style.display = 'none';
                initFirebase();
            } else { document.getElementById('login-error').style.display = 'block'; }
        }

        function initFirebase() {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            document.getElementById('loading-screen').style.display = 'flex';
            db.collection("clients").onSnapshot(snap => {
                localClients = [];
                snap.forEach(doc => { let d = doc.data(); d.id = doc.id; localClients.push(d); });
                document.getElementById('loading-screen').style.display = 'none';
                refreshUI();
            });
        }

        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }

        function navTo(screenId) {
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            let menuId = 'menu-' + screenId;
            if(screenId === 'detalhe') menuId = 'menu-clientes';
            const activeMenu = document.getElementById(menuId);
            if(activeMenu) activeMenu.classList.add('active');

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+screenId).classList.add('active');
            document.querySelector('.sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay').classList.remove('active');

            if(screenId === 'clientes') { renderClients(); setTimeout(()=>document.getElementById('search-client').focus(),100); }
            if(screenId === 'notifications') renderNotifications();
        }

        function refreshUI() {
            let total = 0;
            localClients.forEach(c => {
                const bal = (c.transactions||[]).reduce((a,b)=>a+b.total,0);
                if(bal > 0.05) total += bal;
            });
            document.getElementById('dash-total').innerText = formatCurrency(total);
            document.getElementById('dash-clientes').innerText = localClients.length;
            checkOverdueClients(); 
            if(document.getElementById('view-clientes').classList.contains('active')) renderClients();
            if(document.getElementById('view-notifications').classList.contains('active')) renderNotifications();
            if(document.getElementById('view-detalhe').classList.contains('active') && currentClient) {
                const up = localClients.find(c=>c.id===currentClient.id);
                if(up) { currentClient=up; updateDetailView(); } else { navTo('clientes'); }
            }
        }

        // --- SISTEMA DE NUMERA√á√ÉO ---
        async function getNextNoteNumber() {
            const configRef = db.collection('config').doc('metadata');
            try {
                const doc = await configRef.get();
                let nextNum = 1;
                if (doc.exists) { nextNum = (doc.data().lastNoteNumber || 0) + 1; }
                await configRef.set({ lastNoteNumber: nextNum }, { merge: true });
                return nextNum;
            } catch (e) {
                return Date.now().toString().slice(-4); 
            }
        }

        async function addItem() {
            const desc = document.getElementById('add-desc').value;
            const qtd = parseFloat(document.getElementById('add-qtd').value)||1;
            const val = parseFloat(document.getElementById('add-val').value);
            const dsc = parseFloat(document.getElementById('add-desc-val').value)||0;
            if(!desc || !val) return alert("Preencha dados");
            
            const tot = (qtd*val)-dsc;
            let noteNum = currentClient.activeNoteNumber;

            if (!noteNum && (!currentClient.transactions || currentClient.transactions.length === 0)) {
                if (currentClient.nome.toUpperCase().includes("TESTE")) { noteNum = "TESTE-00"; } 
                else { noteNum = await getNextNoteNumber(); }
            }

            const item = { id: Date.now(), date: new Date().toISOString(), desc, qtd, unit: val, discount: dsc, total: tot, type: 'debt' };
            let trs = currentClient.transactions || []; trs.push(item);
            
            let updateData = { transactions: trs };
            if (noteNum) updateData.activeNoteNumber = noteNum;

            db.collection("clients").doc(currentClient.id).update(updateData).then(() => showToast("Lan√ßado!"));
            
            document.getElementById('add-desc').value=''; document.getElementById('add-val').value=''; document.getElementById('add-desc-val').value=''; document.getElementById('add-qtd').value='1'; document.getElementById('add-desc').focus();
        }

        function novoCadastro() {
            navTo('cadastro'); document.getElementById('form-title').innerText = "Novo Cliente"; document.getElementById('edit-id').value = "";
            document.querySelectorAll('#view-cadastro input').forEach(i=>i.value=''); setTimeout(() => document.getElementById('cad-nome').focus(), 300);
        }

        function prepareEdit() {
            navTo('cadastro'); document.getElementById('form-title').innerText = "Editar Cliente"; document.getElementById('edit-id').value = currentClient.id;
            document.getElementById('cad-nome').value = currentClient.nome; document.getElementById('cad-cpf').value = currentClient.cpf||'';
            document.getElementById('cad-tel').value = currentClient.tel||''; document.getElementById('cad-cidade').value = currentClient.cidade||'';
            document.getElementById('cad-end').value = currentClient.endereco||'';
        }

        function saveClient() {
            const id = document.getElementById('edit-id').value;
            const nome = document.getElementById('cad-nome').value;
            if(!nome) return alert("Nome obrigat√≥rio");
            const data = { nome, cpf: document.getElementById('cad-cpf').value, tel: document.getElementById('cad-tel').value, cidade: document.getElementById('cad-cidade').value, endereco: document.getElementById('cad-end').value };
            if(id) { db.collection("clients").doc(id).update(data).then(()=>{ showToast("Editado!"); navTo('detalhe'); }); } 
            else { data.transactions = []; data.history = []; data.createdAt = new Date().toISOString(); db.collection("clients").add(data).then(()=>{ showToast("Criado!"); navTo('clientes'); }); }
        }

        function deleteClient() { if(confirm("Tem certeza?")) db.collection("clients").doc(currentClient.id).delete().then(()=>{ showToast("Exclu√≠do!"); navTo('clientes'); }); }

        function renderClients() {
            const term = document.getElementById('search-client').value.toLowerCase();
            const tbody = document.getElementById('clientes-list'); tbody.innerHTML='';
            localClients.sort((a,b) => { const balA = (a.transactions||[]).reduce((x,y)=>x+y.total,0); const balB = (b.transactions||[]).reduce((x,y)=>x+y.total,0); return balB - balA; });
            localClients.forEach(c => {
                if(c.nome.toLowerCase().includes(term) || (c.cpf && c.cpf.includes(term))) {
                    const bal = (c.transactions||[]).reduce((a,b)=>a+b.total,0);
                    let st = '<span class="status-badge status-ok">OK</span>';
                    if(bal > 0.05) st = '<span class="status-badge status-debt">Devendo</span>';
                    let notaDisplay = c.activeNoteNumber ? `<b>#${c.activeNoteNumber}</b>` : '-';
                    tbody.innerHTML += `<tr onclick="openClient('${c.id}')" style="cursor:pointer"><td>${notaDisplay}</td><td><b>${c.nome}</b><br><small style="color:#999">${c.cidade||''}</small></td><td style="font-weight:bold; color:${bal>0.05?'var(--danger)':'var(--primary)'}">${formatCurrency(bal)}</td><td>${st}</td><td><button class="action-btn"><i class="fas fa-chevron-right"></i></button></td></tr>`;
                }
            });
        }

        function openClient(id) { currentClient = localClients.find(c=>c.id===id); updateDetailView(); navTo('detalhe'); }

        function updateDetailView() {
            document.getElementById('detalhe-nome').innerText = currentClient.nome;
            document.getElementById('info-cpf').innerText = "CPF: " + (currentClient.cpf||'-');
            document.getElementById('info-tel').innerText = "Tel: " + (currentClient.tel||'-');
            
            const noteBadge = document.getElementById('note-number-display');
            if (currentClient.activeNoteNumber) {
                noteBadge.style.display = 'inline-block';
                noteBadge.innerText = "NOTA N¬∫ " + currentClient.activeNoteNumber;
            } else {
                noteBadge.style.display = 'none';
            }

            const tbody = document.getElementById('detalhe-itens'); tbody.innerHTML = '';
            let total = 0; const trs = currentClient.transactions || [];
            
            trs.forEach(t => {
                total += t.total;
                const isPay = t.type === 'credit';
                tbody.innerHTML += `<tr><td><div style="font-weight:600; color:${isPay?'var(--primary)':'#333'}">${t.desc}</div><small style="color:#999">${t.qtd}x ${Math.abs(t.unit).toFixed(2)} ${t.discount>0?'(-'+t.discount+')':''} ‚Ä¢ ${new Date(t.date).toLocaleDateString()}</small></td><td class="text-right" style="color:${isPay?'var(--primary)':'#333'}; font-weight:bold">${isPay?'-':''} ${Math.abs(t.total).toFixed(2)}</td><td><button style="color:#ccc;border:none;background:none" onclick="deleteItem(${t.id})">&times;</button></td></tr>`;
            });

            document.getElementById('detalhe-saldo').innerText = formatCurrency(total);
            const bQuit = document.getElementById('btn-quitacao');
            const bArch = document.getElementById('btn-archive');
            
            if(total <= 0.05 && trs.length > 0) {
                bQuit.style.display='block'; bArch.style.display='block';
                document.getElementById('detalhe-saldo').style.color = 'var(--primary)';
            } else {
                bQuit.style.display='none'; bArch.style.display='none';
                document.getElementById('detalhe-saldo').style.color = 'var(--danger)';
            }
        }

        function addPayment() {
            const val = parseFloat(document.getElementById('pay-val').value);
            if(!val) return;
            const item = { id: Date.now(), date: new Date().toISOString(), desc: "PAGAMENTO", qtd: 1, unit: val, discount: 0, total: -val, type: 'credit' };
            let trs = currentClient.transactions || []; trs.push(item);
            db.collection("clients").doc(currentClient.id).update({ transactions: trs });
            document.getElementById('pay-val').value='';
        }

        function deleteItem(id) { if(confirm("Apagar?")) { let trs = currentClient.transactions.filter(t=>t.id!==id); db.collection("clients").doc(currentClient.id).update({ transactions: trs }); } }

        function arquivarCiclo() {
            if(confirm("Arquivar conta paga?")) {
                const ciclo = { id: Date.now(), dataArquivamento: new Date().toISOString(), noteNumber: currentClient.activeNoteNumber || '-', itens: [...currentClient.transactions] };
                let hist = currentClient.history || []; hist.push(ciclo);
                db.collection("clients").doc(currentClient.id).update({ transactions: [], history: hist, activeNoteNumber: firebase.firestore.FieldValue.delete() }).then(()=>showToast("Arquivado!"));
            }
        }

        function checkOverdueClients() {
            let count = 0; localClients.forEach(c => { if(getOverdueData(c)) count++; });
            const b = document.getElementById('badge-notify'); if(count>0) { b.style.display='inline-block'; b.innerText=count; } else { b.style.display='none'; }
        }
        
        function getOverdueData(c) {
            const bal = (c.transactions||[]).reduce((a,b)=>a+b.total,0);
            if(bal <= 0.05 || !c.transactions.length) return null;
            
            const d1 = new Date(c.transactions[0].date); 
            
            // --- MODO OFICIAL (35 DIAS) --- 
            d1.setDate(d1.getDate()+35); 
            
            const now = new Date();
            if (now > d1) {
                const diff = Math.ceil((now - d1)/(1000*3600*24));
                return { days: diff > 0 ? diff : "Recente", amount: bal, date: d1 };
            }
            return null;
        }

        // --- RENDERIZA√á√ÉO SEGURA ---
        function renderNotifications() {
            const list = document.getElementById('notification-list'); 
            list.innerHTML=''; 
            let visibleCount = 0;
            
            localClients.forEach(c => {
                try {
                    const over = getOverdueData(c);
                    if(over) { 
                        visibleCount++; 
                        const cleanTel = c.tel ? String(c.tel).replace(/\D/g,'') : '';
                        const msg = encodeURIComponent(`Ol√° ${c.nome}! Aqui √© da AgroVida.\n\nEsta √© uma mensagem autom√°tica do nosso sistema, enviada apenas como lembrete cordial de uma notinha pendente no valor de ${formatCurrency(over.amount)}.\n\nN√£o √© cobran√ßa. Qualquer d√∫vida, conte conosco! üå±`);
                        
                        let wppBtn = '';
                        if (cleanTel.length >= 8) {
                             wppBtn = `<a href="https://wa.me/55${cleanTel}?text=${msg}" target="_blank" class="btn-primary" style="background:#25D366;text-decoration:none; padding:5px 10px; font-size:0.8rem; display:inline-block"><i class="fab fa-whatsapp"></i> Cobrar</a>`;
                        } else {
                             wppBtn = `<button class="btn-primary" style="background:#ccc; cursor:not-allowed; padding:5px 10px; font-size:0.8rem; display:inline-block" disabled>Sem Zap</button>`;
                        }

                        // ELEMENTO DOM SEGURO
                        const div = document.createElement('div');
                        div.className = 'alert-card';
                        div.innerHTML = `
                            <div>
                                <h4>${c.nome} (Nota #${c.activeNoteNumber||'?'})</h4>
                                <small>Vencido h√° ${over.days} dias</small>
                            </div>
                            <div style="display:flex; gap:5px; flex-wrap:wrap">
                                ${wppBtn} 
                                <button class="btn-primary btn-ver-ficha" style="display:inline-block; font-size:0.8rem; padding:5px 10px;">Ver</button>
                            </div>`;
                        
                        div.querySelector('.btn-ver-ficha').onclick = function() { openClient(c.id); };
                        list.appendChild(div);
                    }
                } catch(err) { console.log("Erro notifica√ß√£o", err); }
            });
            
            if(visibleCount === 0) list.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">Ningu√©m atrasado.</p>';
        }

        function abrirModalPrint(tipo) { tipoImpressaoAtual=tipo; document.getElementById('modal-print-overlay').style.display='flex'; }
        function abrirHistorico() {
            const list = document.getElementById('history-list'); list.innerHTML='';
            if(!currentClient.history || !currentClient.history.length) return list.innerHTML='<p style="text-align:center;color:#999">Vazio</p>';
            [...currentClient.history].reverse().forEach((h, i) => {
                list.innerHTML += `<div class="history-item"><div class="history-header"><span>Data: ${new Date(h.dataArquivamento).toLocaleDateString()} - Nota #${h.noteNumber||'?'}</span><button onclick="document.getElementById('h${i}').classList.toggle('show')" style="border:none;background:none;color:var(--primary)">Ver</button></div><div id="h${i}" class="history-detail"><ul style="padding-left:15px;margin:0">${h.itens.map(x=>`<li>${x.qtd}x ${x.desc} (${formatCurrency(x.total)})</li>`).join('')}</ul><button class="btn-primary" style="width:100%;margin-top:10px;font-size:0.8rem" onclick="imprimirHistorico(${h.id})">Imprimir</button></div></div>`;
            });
            document.getElementById('modal-history-overlay').style.display='flex';
        }
        function imprimirHistorico(id) { tipoImpressaoAtual='historico'; dadosImpressaoTemp = currentClient.history.find(h=>h.id===id); document.getElementById('modal-print-overlay').style.display='flex'; }
        
        function executarImpressao(papel) {
            document.getElementById('modal-print-overlay').style.display='none';
            const area = document.getElementById('area-impressao');
            let trs = [], title="", bal=0, notaNum = "";
            
            if(tipoImpressaoAtual==='historico') { 
                trs=dadosImpressaoTemp.itens; title="HIST√ìRICO"; notaNum = dadosImpressaoTemp.noteNumber || "-";
            } else { 
                trs=currentClient.transactions; bal=trs.reduce((a,b)=>a+b.total,0); title=tipoImpressaoAtual==='extrato'?"EXTRATO":"RECIBO"; notaNum = currentClient.activeNoteNumber || "NOVA";
            }
            
            const gerarVia = (nm) => {
                let rows = trs.map(t=>`<tr><td>${t.qtd}x ${t.desc}</td><td class="text-right">${Math.abs(t.total).toFixed(2)}</td></tr>`).join('');
                const css = papel==='bobina'?'estilo-bobina':'estilo-a4';
                return `<div class="via-impressao ${css}"><center><h3>AGROVIDA MAIS</h3><p>${title} N¬∫ ${notaNum}</p><small>${nm}</small></center><hr><p>${currentClient.nome}</p><p>${new Date().toLocaleString()}</p><hr><table>${rows}</table><hr><h3 style="text-align:right">TOTAL: ${formatCurrency(bal)}</h3>${nm.includes('LOJA') ? '<br><br><div class="assinatura-box"><div class="assinatura-linha">Assinatura Cliente</div></div>' : ''}</div>`;
            };

            if(tipoImpressaoAtual==='recibo') {
                const css = papel==='bobina'?'estilo-bobina':'recibo-quitacao';
                const reciboHtml = `<div class="via-impressao ${css}"><center><h3>AGROVIDA MAIS</h3><br><h2>RECIBO</h2><p>Nota Ref: #${notaNum}</p></center><br><p style="text-align:justify">Declaramos que <strong>${currentClient.nome}</strong> (CPF: ${currentClient.cpf||'-'}) realizou a quita√ß√£o total de seus d√©bitos.</p><br><br><div class="assinatura-box"><div class="assinatura-linha">Assinatura</div></div></div>`;
                area.innerHTML = reciboHtml + '<div class="corte-linha"></div>' + reciboHtml; 
            } else {
                area.innerHTML = gerarVia("VIA DA LOJA") + '<div class="corte-linha"></div>' + gerarVia("VIA DO CLIENTE"); 
            }
            window.print();
        }

        document.addEventListener('keydown', e => {
            if(e.key==='Enter' && e.target.classList.contains('input-next')) {
                e.preventDefault();
                if(e.target.id==='search-client') document.activeElement.blur(); 
                else if(e.target.id==='add-desc-val' || (e.target.id==='add-val' && !document.getElementById('add-desc-val').value)) addItem();
                else if(e.target.id==='pay-val') addPayment();
                else { const all = [...document.querySelectorAll('.view-section.active .input-next')]; const idx = all.indexOf(e.target); if(idx>-1 && idx<all.length-1) all[idx+1].focus(); }
            }
        });
    </script>
</body>
</html>
